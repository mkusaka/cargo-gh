name: Release

on:
  push:
    tags:
      - 'v*'       # SemVer
      - '[0-9a-f]*' # Short-hash tags

permissions:
  contents: write  # For release creation and asset upload

jobs:
  # Linux builds
  release-linux:
    name: Release (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build cargo-ghdist
        run: |
          cargo build --release --bin cargo-ghdist
          cp target/release/cargo-ghdist ~/.cargo/bin/ || true

      - name: Run cargo-ghdist (Linux)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          cargo ghdist \
            --tag "$TAG" \
            --targets x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu \
            --format tgz

  # macOS builds
  release-macos:
    name: Release (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build cargo-ghdist
        run: |
          cargo build --release --bin cargo-ghdist
          cp target/release/cargo-ghdist ~/.cargo/bin/ || true

      - name: Run cargo-ghdist (macOS)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          cargo ghdist \
            --tag "$TAG" \
            --targets x86_64-apple-darwin,aarch64-apple-darwin \
            --format tgz

  # Windows builds (optional)
  release-windows:
    name: Release (Windows)
    runs-on: windows-latest
    if: false  # Enable when Windows support is needed

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build cargo-ghdist
        shell: pwsh
        run: |
          cargo build --release --bin cargo-ghdist
          Copy-Item target/release/cargo-ghdist.exe ~/.cargo/bin/ -Force -ErrorAction SilentlyContinue

      - name: Run cargo-ghdist (Windows)
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TAG = $env:GITHUB_REF -replace 'refs/tags/', ''
          cargo ghdist `
            --tag "$TAG" `
            --targets x86_64-pc-windows-msvc `
            --format zip

  # Publish to crates.io (commented out until ready)
  # publish-crates:
  #   name: Publish to crates.io
  #   needs: [release-linux, release-macos]
  #   runs-on: ubuntu-latest
  #   if: false  # Enable when ready to publish to crates.io
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable
  #     
  #     - name: Login to crates.io
  #       run: cargo login ${{ secrets.CRATES_IO_TOKEN }}
  #     
  #     - name: Publish cargo-ghinstall
  #       run: |
  #         cd cargo-ghinstall
  #         cargo publish --dry-run
  #         # cargo publish  # Uncomment when ready
  #     
  #     - name: Publish cargo-ghdist
  #       run: |
  #         cd cargo-ghdist
  #         cargo publish --dry-run
  #         # cargo publish  # Uncomment when ready